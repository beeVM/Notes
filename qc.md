### 基组的说明：
&emsp;&emsp; 所有使用PGTO组合得到的基函数都是AO(原子轨道)，也就是各种软件中使用的AO，但是在核算AO数量的时候需要考虑到轨道的兼并度(s=1,p=3,d=5...)。而在计算中使用到的MO是由AO线性组合得到的，各个AO的系数是由初始猜测再通过SCF迭代的到的(比如HF中的密度矩阵G)
- #### 1 对于pyscf
  - ##### Pople style basis
        以3-21G为例：(12s,9p,3d)-->[5s,4p,2d]
            Zn    S         #使用3个PGTO(原始的高斯函数)组合成一个1s轨道的基函数
               4432.2880000              0.0630930   
                670.6601000              0.3745040
                146.9024000              0.6834160
            Zn    SP        #使用3个PGTO组合成一个3s轨道和一个2p轨道的基函数,第一列为指数，第二列为组合成s轨道的各个PGTO的组合系数，第三列为组合成p轨道的组合系数
                195.0042000             -0.1116280              0.1438060
                 42.5688900              0.0943360              0.5700020
                 13.1214300              0.9611000              0.4533120
            Zn    SP        #使用3个PGTO组合成一个3s轨道和一个3p轨道的基函数
                 13.4023100             -0.2917810              0.0287050
                  4.3999060              0.3426140              0.4862520
                  1.3851480              0.8482840              0.5902350
            Zn    SP        #使用2个PGTO组合成一个4s轨道和一个4p轨道的基函数
                  1.1215580             -0.2023710              0.0003440
                  0.1229440              1.0770350              0.9999050
            Zn    SP        #使用1个PGTO组合成一个4s轨道和一个4p轨道的基函数
                  0.0421930              1.0000000              1.0000000
            Zn    D         #使用2个PGTO组合成一个3d轨道的基函数
                 18.3682000              0.2753860
                  4.5913040              0.8434770
            Zn    D         #使用1个PGTO组合成一个3d轨道的基函数
                  1.0902030              1.0000000
            
        由于Zn的电子排布为1s2s2p3s3p3d4s,所以在划分内外层时将1s2s2p3s3p划为内层,其余为外层而在3-21G基组中，对内层用3个PGTO组合的一个基函数描述，对外层分别用2个和1个PGTO组合的两个不同的基函数来描述，
        所以在行数上，内层都有三行(对应3)，外层都有两行(对应2)和一行(对应1)而对于12s，9p，3d的来源：对s轨道的描述总共用来12个PGTO，p有9个PGTO，d有3个对于5s，4p，2d 
        对s轨道共有5个由PGTO组合出的基函数来描述(1s有一个，2s有一个，3s有一个，4s有两个)，p轨道有4个(2p，3p各有一个,4p有两个)，d轨道有2个(4d的两个)
    


  - ##### 基组的极化与弥散：
        (1). 基组的极化：
        #BASIS SET: (11s,5p) -> [4s,3p]    6-31++G
        Li    S
            642.4189200              0.0021426
             96.7985150              0.0162089
             22.0911210              0.0773156
              6.2010703              0.2457860
              1.9351177              0.4701890
              0.6367358              0.3454708
        Li    SP
              2.3249184             -0.0350917              0.0089415
              0.6324306             -0.1912328              0.1410095
              0.0790534              1.0839878              0.9453637
        Li    SP
              0.0359620              1.0000000              1.0000000
        Li    SP
              0.0074000              1.0000000              1.0000000
        #BASIS SET: (11s,5p,1d) -> [4s,3p,1d]  6-31++G*
        Li    S
            642.4189200              0.0021426
             96.7985150              0.0162089
             22.0911210              0.0773156
              6.2010703              0.2457860
              1.9351177              0.4701890
              0.6367358              0.3454708
        Li    SP
              2.3249184             -0.0350917              0.0089415
              0.6324306             -0.1912328              0.1410095
              0.0790534              1.0839878              0.9453637
        Li    SP
              0.0359620              1.0000000              1.0000000
        Li    SP
              0.0074000              1.0000000              1.0000000
        Li    D
              0.2000000              1.0000000
        #单个极化'*'就是在原先的基础上加一个由单个PGTO组合的d轨道(H和He不变，原先有d轨道原子不用6-31++G*而用6-31++G**)

        #BASIS SET: (22s,16p,4d) -> [5s,4p,2d] 6-31++G
        V    S
          47354.3300000              1.784513E-03
           7110.7870000              1.366754E-02
           1619.5910000              6.736122E-02
            456.3379000              2.330552E-01
            146.0606000              4.806316E-01
             49.7579100              3.474802E-01
        V    SP
            968.1484000              2.410599E-03           3.995005E-03
            230.2821000              3.207243E-02           3.104061E-02
             74.1459100              1.245942E-01           1.347747E-01
             27.6410700             -3.482177E-02           3.437279E-01
             11.1147500             -6.167374E-01           4.628759E-01
              4.5431130             -4.509844E-01           2.135547E-01
        V    SP
             37.6405000             -3.233199E-03          -6.494056E-03
             12.2823800              7.130744E-02          -2.753453E-02
              5.2333660              2.543820E-01           5.516284E-02
              2.2089500             -2.933887E-01           3.879672E-01
              0.9178800             -7.415695E-01           5.090258E-01
              0.3634120             -1.909410E-01           1.803840E-01
        V    SP
              1.3927810              6.139703E-02          -0.1891265
              0.5439130              3.061130E-01           0.08005453
              0.0914760             -1.154890E+00           0.9877399
        V    SP
              0.0343120              1.000000E+00           1.00000000
        V    D
             16.0502500              8.599899E-02
              4.1600630              3.802996E-01
              1.2432650              7.127659E-01
        V    D
              0.3442770              1.000000E+00
        #BASIS SET: (22s,16p,4d,1f) -> [5s,4p,2d,1f]  6-31++G**
        V    S
          47354.3300000              1.784513E-03
           7110.7870000              1.366754E-02
           1619.5910000              6.736122E-02
            456.3379000              2.330552E-01
            146.0606000              4.806316E-01
             49.7579100              3.474802E-01
        V    SP
            968.1484000              2.410599E-03           3.995005E-03
            230.2821000              3.207243E-02           3.104061E-02
             74.1459100              1.245942E-01           1.347747E-01
             27.6410700             -3.482177E-02           3.437279E-01
             11.1147500             -6.167374E-01           4.628759E-01
              4.5431130             -4.509844E-01           2.135547E-01
        V    SP
             37.6405000             -3.233199E-03          -6.494056E-03
             12.2823800              7.130744E-02          -2.753453E-02
              5.2333660              2.543820E-01           5.516284E-02
              2.2089500             -2.933887E-01           3.879672E-01
              0.9178800             -7.415695E-01           5.090258E-01
              0.3634120             -1.909410E-01           1.803840E-01
        V    SP
              1.3927810              6.139703E-02          -0.1891265
              0.5439130              3.061130E-01           0.08005453
              0.0914760             -1.154890E+00           0.9877399
        V    SP
              0.0343120              1.000000E+00           1.00000000
        V    D
             16.0502500              8.599899E-02
              4.1600630              3.802996E-01
              1.2432650              7.127659E-01
        V    D
              0.3442770              1.000000E+00
        V    F
              0.8000000              1.000000E+00
        #两个极化'**'的是在原来的基础上加一个f轨道(若原子没有d轨道则不加f轨道而是加d轨道，原先有d轨道的加f轨道)


	    (2).基组的弥散：
        #BASIS SET: (10s,4p) -> [3s,2p]  6-31G
        Li    S
            642.4189200              0.0021426
             96.7985150              0.0162089
             22.0911210              0.0773156
              6.2010703              0.2457860
              1.9351177              0.4701890
              0.6367358              0.3454708
        Li    SP
              2.3249184             -0.0350917              0.0089415
              0.6324306             -0.1912328              0.1410095
              0.0790534              1.0839878              0.9453637
        Li    SP
              0.0359620              1.0000000              1.0000000
         61 #BASIS SET: (11s,5p) -> [4s,3p]   6-31+G
        Li    S
            642.4189200              0.0021426
             96.7985150              0.0162089
             22.0911210              0.0773156
              6.2010703              0.2457860
              1.9351177              0.4701890
              0.6367358              0.3454708
        Li    SP
              2.3249184             -0.0350917              0.0089415
              0.6324306             -0.1912328              0.1410095
              0.0790534              1.0839878              0.9453637
        Li    SP
              0.0359620              1.0000000              1.0000000
        Li    SP
              0.0074000              1.0000000              1.0000000
        
        #BASIS SET: (22s,16p,4d) -> [5s,4p,2d]  6-31G
        V    S
          47354.3300000              1.784513E-03
           7110.7870000              1.366754E-02
           1619.5910000              6.736122E-02
            456.3379000              2.330552E-01
            146.0606000              4.806316E-01
             49.7579100              3.474802E-01
        V    SP
            968.1484000              2.410599E-03           3.995005E-03
            230.2821000              3.207243E-02           3.104061E-02
             74.1459100              1.245942E-01           1.347747E-01
             27.6410700             -3.482177E-02           3.437279E-01
             11.1147500             -6.167374E-01           4.628759E-01
              4.5431130             -4.509844E-01           2.135547E-01
        V    SP
             37.6405000             -3.233199E-03          -6.494056E-03
             12.2823800              7.130744E-02          -2.753453E-02
              5.2333660              2.543820E-01           5.516284E-02
              2.2089500             -2.933887E-01           3.879672E-01
              0.9178800             -7.415695E-01           5.090258E-01
              0.3634120             -1.909410E-01           1.803840E-01
        V    SP
              1.3927810              6.139703E-02          -0.1891265
              0.5439130              3.061130E-01           0.08005453
              0.0914760             -1.154890E+00           0.9877399
        V    SP
              0.0343120              1.000000E+00           1.00000000
        V    D
             16.0502500              8.599899E-02
              4.1600630              3.802996E-01
              1.2432650              7.127659E-01
        V    D
              0.3442770              1.0000000
        #BASIS SET: (22s,16p,4d) -> [5s,4p,2d]  6-31++G
        V    S
          47354.3300000              1.784513E-03
           7110.7870000              1.366754E-02
           1619.5910000              6.736122E-02
            456.3379000              2.330552E-01
            146.0606000              4.806316E-01
             49.7579100              3.474802E-01
        V    SP
            968.1484000              2.410599E-03           3.995005E-03
            230.2821000              3.207243E-02           3.104061E-02
             74.1459100              1.245942E-01           1.347747E-01
             27.6410700             -3.482177E-02           3.437279E-01
             11.1147500             -6.167374E-01           4.628759E-01
              4.5431130             -4.509844E-01           2.135547E-01
        V    SP
             37.6405000             -3.233199E-03          -6.494056E-03
             12.2823800              7.130744E-02          -2.753453E-02
              5.2333660              2.543820E-01           5.516284E-02
              2.2089500             -2.933887E-01           3.879672E-01
              0.9178800             -7.415695E-01           5.090258E-01
              0.3634120             -1.909410E-01           1.803840E-01
        V    SP
              1.3927810              6.139703E-02          -0.1891265
              0.5439130              3.061130E-01           0.08005453
              0.0914760             -1.154890E+00           0.9877399
        V    SP
              0.0343120              1.000000E+00           1.00000000
        V    D
             16.0502500              8.599899E-02
              4.1600630              3.802996E-01
              1.2432650              7.127659E-01
        V    D
              0.3442770              1.000000E+00
        加一个弥散'+'，就是对外层(valence)的轨道再加一个由单个PGTO组合的基函数，比如6-31+G约等于6-311G(结构相似，但是指数和系数完全不同)(另外，这是对于除了H和He的原子)

        加两个弥散'++'，其它原子都相当于6-31+G，对于H和He则是加一个由单个PGTO组合的基函数
	- 对于各种名称的基组文件，都有相类似的原则：例如pyscf中的cc-*基组，是将轨道按照spdf分类，并根据其属于内层或者外层使用规定个PGTO用来组合成基函数  
  

    &emsp;&emsp; **总的来说，加极化是在原先的基组之上每个轨道都再加一组PGTO(即原来用几个PGTO，就要加几个PGTO)，而加弥散则是在原先的基础上在最外层加一个很小系数的PGTO去描述**
	#
- #### 2对于CFOUR
    &emsp;&emsp;**基组则分为若干部分**

        C:PVDZ_DK                      #基组名称
        EMSL BASIS SET LIBRARY
        
          3                            #总共分的层数
            0    1    2                #代表的轨道，s=0,p=1,d=2,f=3...
            3    2    1                #代表由PGTO组合的轨道总数(也就是未考虑轨道兼并时AO的数量)，s层有3个，p有2个，d有1个(其中1s为内层有3个，2s为外层用了6个，2p为外层用了4个，3d用了1个)
            9    4    1                #代表用的不同的PGTO总数
        #   s    p    d  轨道
           6665.000000   1000.000000    228.000000     64.710000     21.060000      #这是组合1s和2s的部分     #这两行是在组合PGTO时各个PGTO的e指数
              7.495000      2.797000      0.521500      0.159600
        #    1s        2s          2s  
         0.0008517 -0.0001803  0.0000000                                                             
        #这是组合PGTO时各个PGTO前的系数
         0.0055121 -0.0011949  0.0000000
         0.0273690 -0.0057943  0.0000000
         0.1020568 -0.0234166  0.0000000
         0.2749479 -0.0640500  0.0000000
         0.4483409 -0.1500919  0.0000000
         0.2847131 -0.1268376  0.0000000
         0.0151750  0.5451602  0.0000000
        -0.0031842  0.5797815  1.0000000
        
              9.439000      2.002000      0.545600      0.151700      #这是组合2p的部分
        #    2p         2p
         0.0381635  0.0000000                       
         0.2094925  0.0000000
         0.5084477  0.0000000
         0.4689417  1.0000000
        
              0.550000                                #这是组合3d的部分
        #    3d
         1.0000000
    
&nbsp;
&nbsp;
&nbsp;
&nbsp;
&nbsp;
&nbsp;
&nbsp;
&nbsp;



### pyscf和cfour的输出文件中的分子轨道相关信息
&emsp;&emsp;若为闭壳层，则$\alpha$和$\beta$在一起，最后的成分分析中直接数轨道就行；
&emsp;&emsp;若为开壳层，则$\alpha$和$\beta$轨道分开输出，在轨道指认时，考虑始态和末态的多重度（单线态，双重态，三线态等等）可以确认变换的是$\alpha$轨道还是$\beta$轨道。激发态的跃迁成分中显示的轨道序数都是从占据轨道开始算（能量由低到高）。



&nbsp;
&nbsp;
&nbsp;
&nbsp;
&nbsp;
&nbsp;
&nbsp;
&nbsp;


_**波函数在一个完备基上线性展开时，各个基向量前的系数可以有投影得到，即将原波函数与每个基向量作内积(向基向量投影)**_





## Davidson 算法
`davidson_nosym1` 是 PySCF 中用于求解**非对称矩阵特征值问题**的 Davidson 迭代算法实现。它通过子空间迭代逐步逼近特征值和特征向量。下面我们逐行详细解析该函数的实现逻辑和关键步骤。

---

### **函数签名**
```python
def davidson_nosym1(aop, x0, precond, tol=1e-12, max_cycle=50, max_space=20,
                    lindep=DAVIDSON_LINDEP, max_memory=MAX_MEMORY,
                    dot=numpy.dot, callback=None,
                    nroots=1, lessio=False, left=False, pick=pick_real_eigs,
                    verbose=logger.WARN, follow_state=FOLLOW_STATE,
                    tol_residual=None, fill_heff=_fill_heff):
```
- **输入参数**：
  - `aop`：矩阵-向量乘法函数，输入向量列表 `[x]`，返回 `[A*x]`。
  - `x0`：初始猜测向量（或向量列表）。
  - `precond`：预处理函数或对角矩阵。
  - `tol`：收敛容忍度（默认 `1e-12`）。
  - `max_cycle`：最大迭代次数（默认 50）。
  - `max_space`：子空间最大维度（默认 20）。
  - `lindep`：线性依赖阈值（默认 `1e-14`）。
  - `left`：是否计算左特征向量（默认 `False`）。
  - `pick`：过滤特征值的函数（默认 `pick_real_eigs`）。

- **输出**：
  - `conv`：布尔数组，标记各特征值是否收敛。
  - `e`：特征值列表。
  - `x`：右特征向量列表。
  - （可选）`xl`：左特征向量列表（当 `left=True`）。

---

### **初始化阶段**
#### 1. 日志和参数检查
```python
if isinstance(verbose, logger.Logger):
    log = verbose
else:
    log = logger.Logger(misc.StreamObject.stdout, verbose)

if tol_residual is None:
    toloose = numpy.sqrt(tol)
else:
    toloose = tol_residual
log.debug1('tol %g  toloose %g', tol, toloose)
```
- 初始化日志对象。
- 计算残差收敛阈值 `toloose`（若未直接提供 `tol_residual`，则取 `sqrt(tol)`）。

#### 2. 预处理函数处理
```python
if not callable(precond):
    precond = make_diag_precond(precond)
```
- 如果 `precond` 不是函数，将其转换为对角预处理函数（例如 `dx / (diag(A) - e)`）。

#### 3. 初始猜测处理
```python
if callable(x0):
    x0 = x0()
if isinstance(x0, numpy.ndarray) and x0.ndim == 1:
    x0 = [x0]
```
- 若 `x0` 是函数，调用它生成初始向量。
- 若 `x0` 是单向量，转换为列表形式。

#### 4. 内存和子空间设置
```python
max_space = max_space + (nroots-1) * 6
_incore = max_memory*1e6/x0[0].nbytes > max_space*2+nroots*3
lessio = lessio and not _incore
```
- 扩展 `max_space` 以容纳多根计算。
- 判断是否在内存中存储子空间向量（`_incore`）。

---

### **迭代主循环**
#### 1. 子空间初始化
```python
if fresh_start:
    if _incore:
        xs = []
        ax = []
    else:
        xs = _Xlist()
        ax = _Xlist()
    space = 0
    xt, x0 = _qr(x0, dot, lindep)[0], None
```
- 若需重新开始（`fresh_start`），初始化子空间向量列表 `xs` 和 `ax`。
- 对初始猜测 `x0` 做 QR 分解，生成正交基 `xt`。

#### 2. 矩阵乘法和子空间扩展
```python
axt = aop(xt)  #aop是一个匿名函数
for k, xi in enumerate(xt):
    xs.append(xt[k])
    ax.append(axt[k])
space += len(xt)
```
- 计算 `A*xt` 并扩展子空间。

#### 3. 构建投影矩阵 `heff`
```python
if dtype is None:
    dtype = numpy.result_type(*axt, *xt)
if heff is None:
    heff = numpy.empty((max_space+nroots, max_space+nroots), dtype=dtype)
fill_heff(heff, xs, ax, xt, axt, dot)
```
- 初始化子空间矩阵 `heff` 的数据类型。
- 调用 `_fill_heff` 填充投影矩阵 \( H_{ij} = \langle x_i | A | x_j \rangle \)。

#### 4. 子空间对角化
```python
w, v = scipy.linalg.eig(heff[:space,:space])
if callable(pick):
    w, v, idx = pick(w, v, nroots, locals())
```
- 对 `heff` 做对角化，得到近似特征值 `w` 和特征向量 `v`。
- 使用 `pick` 函数筛选物理合理的特征值（如剔除虚部过大的解）。

#### 5. 生成新试探向量
```python
x0 = _gen_x0(v[:,:nroots], xs)
if lessio:
    ax0 = aop(x0)
else:
    ax0 = _gen_x0(v[:,:nroots], ax)
```
- 通过子空间特征向量组合生成新猜测 `x0`。
- 计算 `A*x0`（直接调用 `aop` 或从子空间组合）。

#### 6. 残差计算和收敛判断
```python
for k, ek in enumerate(e):
    xt[k] = ax0[k] - ek * x0[k]
    dx_norm[k] = numpy.sqrt(dot(xt[k].conj(), xt[k]).real)
    conv[k] = abs(de[k]) < tol and dx_norm[k] < toloose
```
- 计算残差 \( r = A x - e x \) 及其范数。
- 若特征值变化量 `de` 和残差范数均小于阈值，标记为收敛。

#### 7. 预处理和线性依赖处理
```python
xt[k] = precond(xt[k], e[0], x0[k])
xt[k] *= dot(xt[k].conj(), xt[k]).real ** -.5
```
- 对残差向量做预处理，加速收敛。
- 归一化并剔除线性相关的试探向量。

---

### **终止和输出**
#### 1. 收敛检查
```python
if all(conv):
    break
```
- 若所有特征值收敛，退出迭代。

#### 2. 左特征向量计算（可选）
```python
if left:
    w, vl, v = scipy.linalg.eig(heff[:space,:space], left=True)
    xl = _gen_x0(vl[:,idx[:nroots]], xs)
```
- 若需左特征向量，对 `heff` 做左右对角化。

#### 3. 返回结果
```python
return numpy.asarray(conv), e, x0
```
- 返回收敛状态、特征值和特征向量。

---

### **关键函数说明**
`_qr`： 在 `davidson_nosym1` 函数中，正交化的过程基于 **Gram-Schmidt 正交化** 的数学原理，并结合了 **QR 分解** 的数值实现。以下是详细的数学依据及其在代码中的体现：

#### **1. Gram-Schmidt 正交化的数学原理**
Gram-Schmidt 过程将一组线性无关的向量 \(\{v_1, v_2, \dots, v_n\}\) 转换为正交基 \(\{q_1, q_2, \dots, q_n\}\)，步骤如下：
1. **第一个向量**：直接归一化  
   \[
   q_1 = \frac{v_1}{\|v_1\|}
   \]
2. **后续向量**：依次减去在前面的正交基上的投影  
   \[
   u_k = v_k - \sum_{j=1}^{k-1} \langle q_j, v_k \rangle q_j, \quad q_k = \frac{u_k}{\|u_k\|}
   \]
   - \(\langle \cdot, \cdot \rangle\) 是内积（在代码中通过 `dot` 函数实现）。
   - 若 \( \|u_k\| \) 接近零（小于 `lindep`），则丢弃 \(v_k\)（线性依赖）。

---

#### **2. 代码中的实现（`_qr` 函数）**
```python
def _qr(xs, dot, lindep=1e-14):
    nvec = len(xs)
    xs = qs = numpy.array(xs, copy=True)  # 输入向量列表
    rmat = numpy.eye(nvec, order='F', dtype=xs.dtype)  # 初始化R矩阵

    nv = 0  # 记录有效正交基的数量
    for i in range(nvec):
        xi = xs[i]
        for j in range(nv):
            prod = dot(qs[j].conj(), xi)  # 计算投影系数 <q_j | x_i>
            xi -= qs[j] * prod            # 减去投影分量（Gram-Schmidt核心步骤）
            rmat[:,nv] -= rmat[:,j] * prod  # 更新R矩阵
        innerprod = dot(xi.conj(), xi).real  # 计算剩余向量的范数平方
        norm = numpy.sqrt(innerprod)
        if innerprod > lindep:            # 判断线性依赖
            qs[nv] = xi / norm            # 归一化得到正交基q_k
            rmat[:nv+1,nv] /= norm        # 更新R矩阵
            nv += 1
    return qs[:nv], numpy.linalg.inv(rmat[:nv,:nv])  # 返回正交基和R^{-1}
```

#### **关键点**：
- **投影剔除**：通过 `xi -= qs[j] * prod` 实现 Gram-Schmidt 的投影减法。
- **线性依赖检查**：若剩余范数 `innerprod < lindep`，丢弃该向量。
- **R矩阵的作用**：记录正交化过程中的线性组合系数，用于恢复原始向量（虽在 Davidson 中未直接使用，但保留数学完整性）。

---

### **3. 为什么需要正交化？数学意义**
1. **子空间方法的稳定性**：
   - Davidson 算法通过子空间迭代逼近特征解。若子空间基非正交，矩阵 \( H_\text{eff} = X^\dagger A X \) 的条件数会变差，导致对角化数值不稳定。
   - 正交基保证 \( X^\dagger X = I \)，避免冗余计算。

2. **避免“信息重复”**：
   - 线性相关的向量会导致 \( H_\text{eff} \) 奇异，无法求解特征值。

3. **残差向量的有效性**：
   - 预处理后的残差向量需与当前子空间正交，才能生成新的有效试探方向（否则会陷入已有子空间）。

---



